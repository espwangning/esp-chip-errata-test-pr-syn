[USB OTG] USB OTG 使用 AHB 总线仲裁时出现异常数据
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. only:: esp32s2

   .. tags::

      v0.0

描述
^^^^

ESP32-S2 USB OTG 和以下外设同时请求高性能总线 (AHB) 时，AHB 总线可能产生错误仲裁信号，导致 USB OTG 的读写操作出现异常数据。存在冲突的外设包括:

* I2S
* SPI

变通方法
^^^^^^^^

1. 避免 USB OTG 和以上外设产生 AHB 总线竞争：不使用 USB OTG 的 DMA 模式，或不开启以上外设的 DMA 模式。
2. 避免 USB OTG 使用 AHB 总线期间被打断：设置 USB OTG 的 AHB Burst 为 INCR 模式，该模式下 USB OTG 将独占 AHB 总线直到 Burst 传输完成。

.. note::
    请谨慎使用 INCR 模式，因其需要调整 USB OTG 端点最大包大小 (MPS)，使 Burst 时间小于以上外设的等待超 时。

解决方案
^^^^^^^^

已在芯片版本 :bdg-success:`v1.0` 中修复。修复后，AHB 总线即可正确仲裁竞争访问。
ESP-IDF 从 v4.4 版本起支持 USB Host，该功能需要使用到 DMA。当满足下述部分条件时，ESP-IDF 采用上述的方法 2 作为变通方案，使用 INCR 模式独占总线。在该模式下，使用 USB Host 时，其他外设无法安全地使用 DMA 访问 AHB 总线。ESP-IDF 启用变通方案的条件如下:

1. 使用芯片版本 v0.0 时，ESP-IDF 始终启用变通方案。
2. ESP-IDF 在 v4.4.6, v5.0.4, v5.1.2 及 v5.2 版本增加了对芯片版本 v1.0 的支持，软件会自动识别使用的芯片版本。在这些及以上版本中，使用芯片版本 v1.0 及以上芯片版本时，ESP-IDF 不再启用变通方案。
3. 在不支持芯片版本 v1.0 的 ESP-IDF 版本中，即 v4.4-v4.4.5，v5.0-v5.0.3，v5.1-v5.1.1，ESP-IDF 始终启用变通方案。
